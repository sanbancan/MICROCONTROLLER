;t8.asm
;counter 0000 to 9999 with ascii values, with interrupt
;Interrupt based display driver
;----------------------------------------------------------------------
	CHIP 8052
	.list on
;----------------------------------------------------------------------
;Define byte variables...
ds1:		EQU	30h	;location for displaying value on display1
ds2:		EQU	31h	;location for displaying value on display2
ds3:		EQU	32h	;location for displaying value on display3
ds4:		EQU	33h	;location for displaying value on display4
;
dcount_1:	EQU	34h	;variable for generating delay
dcount_2:	EQU	35h	;variable for generating delay
dcount_3:	EQU	36h	;variable for generating delay
;
count:		EQU	37h	;
scan_no:	EQU	38h
;---------------------------------------------------
;define imidiate values..
top_of_stack:	EQU	60h
;---------------------------------------------------
;define bit variables here
sl1:	REG	P2.0		;display1
sl2:	REG	P2.1		;display2
sl3:	REG	P2.2		;display3
sl4:	REG	P2.3		;display4
;----------------------------------------------------------------------
	org 	0000h
	jmp	main
;----------------------------------------------------------------------
	org     0003h
	reti			;ljmp	isr_i0
;
	org     000bh
	ljmp	isr_t0		;timer0 interrupt
;
	org     0013h
	reti			;ljmp    isr_i1
;
	org     001bh
	reti
	;ljmp	isr_t1		;timer1 interrupt
				;(isr_t1)baud rate for Usart
				;(...hence no Interrupt)
;
	org     0023h
         reti
	;ljmp    isr_receive         ;Interrupt enabled only for receive.
;
	org     002bh
         reti
	;ljmp    isr_t2
;
;----------------------------------------------------------------------

;----------------------------------------------------------------------
main:
	mov	sp,#top_of_stack
	call	init		;init timer,display,etc.
;
	setb	ea		;enable all interupts
;
	call	test_display
;
;initilise the counter...

	mov	ds1,#"0"
	mov	ds2,#"0"
	mov	ds3,#"0"
	mov	ds4,#"0"
;
l1_main:
	call	wait_1sec
	call	inc_d
	jmp	l1_main	
;**********************************************************

;----------------------------------------------------------------------
;initialising routines done here...
;----------------------------------------------------------------------
init:
;--------------------------
	mov	scan_no,#00h
;--------------------------
	call	init_display
;--------------------------		
	call	init_timer0
;--------------------------
	ret
;----------------------------------------------------------------------

;---------------------------------------------------
init_display:
	mov	ds1,#"9"+2	;glow all segments
	mov	ds2,#"9"+2
	mov	ds3,#"9"+2
	mov	ds4,#"9"+2
	ret
;---------------------------------------------------


;---------------------------------------------------
	;(89h)
	;TMOD-->GATE, C/T, M1,	M0, GATE, C/T, M1, M0, T/C (timer1,timer0)
	;init timer 0  for 1msec
init_timer0:
	orl	tmod,#01h		;t0 in 16 bit timer mode.
	mov	tl0,#66h		;Init timer0 with count for 1msec.
	mov	th0,#0fch		;count=0fc66h for 1msec.
	setb	tr0			;start timer 0.
        setb	et0			;enable timer 0 Interrupt.
	ret 
;---------------------------------------------------


;---------------------------------------------------
isr_t0:
	push	a
	push	psw
	push	dph
	push	dpl
;

	call	init_timer0
	call	scanner			;spoils a,psw,dptr
out_isr:
	pop	dpl
	pop	dph
	pop	psw
	pop	a
	reti
;---------------------------------------------------



;----------------------------------------------------------------------
scanner:	
;---------------------------------------------------
	mov	a,scan_no
;---------------------------------------------------


;-(0)------------------------------------------------------------------
zero:
	cjne	a,#00d,one		;
;----------------------------------------
;key_output_line
	clr	sl1			;select display/row 1
	setb	sl2			;
	setb	sl3			;
	setb	sl4			;
;----------------------------------------
	call	adisp1
;----------------------------------------
	mov	scan_no,#01d
	ajmp	out_scanner
;----------------------------------------------------------------------


;-(1)------------------------------------------------------------------
one:
	cjne	a,#01d,two		;
;----------------------------------------
;----------------------------------------
	mov	scan_no,#02d	
	ajmp	out_scanner
;----------------------------------------------------------------------


;-(2)------------------------------------------------------------------
two:
	cjne	a,#02d,three		;
;----------------------------------------
;----------------------------------------
	mov	scan_no,#03d
	ajmp	out_scanner
;----------------------------------------------------------------------



;-(3)------------------------------------------------------------------
three:
	cjne	a,#03d,four		;
;----------------------------------------
	call	disp_blank
;----------------------------------------
	mov	scan_no,#04d
	ajmp	out_scanner
;----------------------------------------------------------------------



;-(4)------------------------------------------------------------------
four:
	cjne	a,#04d,five		;
;----------------------------------------
;key_output_line
	setb	sl1			;
	clr	sl2			;select display/row 2
	setb	sl3			;
	setb	sl4			;
;----------------------------------------
	call	adisp2
;----------------------------------------
	mov	scan_no,#05d
	ajmp	out_scanner
;----------------------------------------------------------------------



;-(5)------------------------------------------------------------------
five:
	cjne	a,#05d,six		;
;----------------------------------------
;----------------------------------------
	mov	scan_no,#06d
	ajmp	out_scanner
;----------------------------------------------------------------------



;-(6)------------------------------------------------------------------
six:
	cjne	a,#06d,seven		;
;----------------------------------------
;----------------------------------------
	mov	scan_no,#07d
	ajmp	out_scanner
;----------------------------------------------------------------------



;-(7)------------------------------------------------------------------
seven:
	cjne	a,#07d,eight		;
;----------------------------------------
	call	disp_blank
;----------------------------------------
	mov	scan_no,#08d
	ajmp	out_scanner
;----------------------------------------------------------------------



;-(8)------------------------------------------------------------------
eight:
	cjne	a,#08d,nine		;
;----------------------------------------
;key_output_line
	setb	sl1			;
	setb	sl2			;
	clr	sl3			;select display/row 3
	setb	sl4			;
;----------------------------------------
	call	adisp3
;----------------------------------------
	mov	scan_no,#09d
	ajmp	out_scanner
;----------------------------------------------------------------------


;-(9)------------------------------------------------------------------
nine:
	cjne	a,#09d,ten		;
;----------------------------------------
;----------------------------------------
	mov	scan_no,#10d
	ajmp	out_scanner
;----------------------------------------------------------------------

;-(10(a))--------------------------------------------------------------
ten:
	cjne	a,#10d,eleven		;
;----------------------------------------
;----------------------------------------
	mov	scan_no,#11d
	ajmp	out_scanner
;----------------------------------------------------------------------


;-(11(b))--------------------------------------------------------------
eleven:
	cjne	a,#11d,twelve		;
;----------------------------------------
	call	disp_blank
;----------------------------------------
	mov	scan_no,#12d
	ajmp	out_scanner
;----------------------------------------------------------------------


;-(12(c))--------------------------------------------------------------
twelve:
	cjne	a,#12d,thirteen		;
;----------------------------------------
;key_output_line
	setb	sl1			;
	setb	sl2			;
	setb	sl3			;
	clr	sl4			;select display/row 4
;----------------------------------------
	call	adisp4
;----------------------------------------
	mov	scan_no,#13d
	ajmp	out_scanner
;----------------------------------------------------------------------

;-(13(d))--------------------------------------------------------------
thirteen:
	cjne	a,#13d,fourteen		;
;----------------------------------------
;----------------------------------------
	mov	scan_no,#14d
	ajmp	out_scanner
;----------------------------------------------------------------------

;-(14(e))--------------------------------------------------------------
fourteen:
	cjne	a,#14d,fifteen		;
;----------------------------------------
;----------------------------------------
	mov	scan_no,#15d
	ajmp	out_scanner
;----------------------------------------------------------------------

;-(15(f))--------------------------------------------------------------
fifteen:
	cjne	a,#15d,dummy		;
;----------------------------------------
	call	disp_blank
;----------------------------------------
dummy:	mov	scan_no,#00d
	ajmp	out_scanner

;----------------------------------------------------------------------

out_scanner:
;	
	ret
;-----------------------------------------------------------------------



;----------------------------------------------------------------------
;Subroutines here onwards...
;disp_blank
;adisp1,2,3,4
;test_display
;wait_1sec
;wait_20ms
;inc_d

;---------------------------------------------------
disp_blank:
	mov 	p0,#00h
	ret

;---------------------------------------------------
adisp1:
	mov 	dptr,#adisp_lut
	mov 	a,ds1
	clr	c
	subb	a,#"0"
	movc 	a,@a+dptr
	mov 	p0,a
	ret

;------------------------------------------
adisp2:
	mov 	dptr,#adisp_lut
	mov 	a,ds2
	clr	c
	subb	a,#"0"
	movc 	a,@a+dptr
	mov 	p0,a
	ret

;------------------------------------------
adisp3:
	mov 	dptr,#adisp_lut
	mov 	a,ds3
	clr	c
	subb	a,#"0"
	movc 	a,@a+dptr
	mov 	p0,a
	ret

;------------------------------------------
adisp4:
	mov 	dptr,#adisp_lut
	mov 	a,ds4
	clr	c
	subb	a,#"0"
	movc 	a,@a+dptr
	mov 	p0,a
	ret
;---------------------------------------------------

;---------------------------------------------------
adisp_lut:
	db 	11111100b	;0
	db 	01100000b	;1
	db 	11011010b	;2
	db 	11110010b	;3
	db 	01100110b	;4
	db 	10110110b	;5
	db 	10111110b	;6
	db 	11100000b	;7
	db 	11111110b	;8
	db 	11110110b	;9
;
	db	00000000b	;"9"+1 code for SPACE
	db	11111111b	;3b
	db	11111111b	;3c
	db	11111111b	;3d
	db	11111111b	;3e
	db	11111111b	;3f
	db	11111111b	;40
;
	db 	11101110b	;a
	db 	00111110b	;b
	db 	10011100b	;c
	db 	01111010b	;d
	db 	10011110b	;e			
	db 	10001110b	;f

;---------------------------------------------------

;---------------------------------------------------
test_display:
	mov	ds1,#"9"+2	;glow all segments
	mov	ds2,#"9"+2
	mov	ds3,#"9"+2
	mov	ds4,#"9"+2
;
	call	wait_1sec
;
	mov	ds1,#"9"+1	;put off all segments
	mov	ds2,#"9"+1
	mov	ds3,#"9"+1
	mov	ds4,#"9"+1
;
	call	wait_1sec
;
	ret
;---------------------------------------------------

;--------------------------------------------------- 
wait_1sec:
	mov	dcount_3,#07d
l2:	mov 	dcount_2,#0ffh
l1:	mov 	dcount_1,#0ffh
	djnz 	dcount_1,$
	djnz 	dcount_2,l1
	djnz 	dcount_3,l2
	ret
;---------------------------------------------------


;---------------------------------------------------
wait_20ms:
	mov	dcount_2,#55h
	mov	dcount_1,#0ffh		;$-3-3
	djnz	dcount_1,$		;$-3
	djnz	dcount_2,$-3-3
	ret
;---------------------------------------------------



;---------------------------------------------------
;Increments value of ds4 ds3 ds2 ds1 considering as a single
;four digit no from 0000 to 9999
inc_d:
	inc 	ds1
	mov 	a,ds1
	cjne 	a,#"9"+1,$+3
	jnc 	l1_id 
	ret

;------------------------------------------
l1_id:	mov 	ds1,#"0"
	inc 	ds2
	mov 	a,ds2
	cjne 	a,#"9"+1,$+3
	jnc 	l2_id
	ret

;------------------------------------------
l2_id:	mov 	ds2,#"0"
	inc 	ds3
	mov 	a,ds3
	cjne 	a,#"9"+1,$+3 
	jnc 	l3_id
	ret

;------------------------------------------
l3_id:	mov 	ds3,#"0"
	inc 	ds4 
	mov 	a,ds4
	cjne 	a,#"9"+1,out_id
;
	mov	ds1,#"0"
	mov	ds2,#"0"
	mov	ds3,#"0"
	mov	ds4,#"0"
;
out_id:
	ret
;---------------------------------------------------


;----------------------------------------------------------------------
	end
	